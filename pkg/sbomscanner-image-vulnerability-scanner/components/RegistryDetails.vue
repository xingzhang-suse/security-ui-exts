<template>
  <div class="registry-details">
    <div class="about">
      <div class="header">
        <div class="resource-header">
          <div class="resource-header-name-state">
            <span class="resource-header-name">
              <RouterLink :to="`/c/${$route.params.cluster}/${ PRODUCT_NAME }/${PAGE.REGISTRIES}`">{{ t('imageScanner.registries.title') }}:</RouterLink>
              {{ $route.params.id }}
            </span>
            <RegisterStatusBadge :status="registryStatus" />
          </div>
          <span class="resource-header-description">
            Registry configuration description
          </span>
        </div>
        <div class="resource-header-actions">
          <button
            class="btn role-secondary"
            aria-label="Refresh data"
            type="button"
            @click="loadData(true)"
          >
            <i class="icon icon-refresh"></i>
            {{ t('imageScanner.general.refresh') }}
          </button>
          <ScanButton
            :selected-registries="[{name: $route.params.id, namespace: $route.params.ns, currStatus: registryStatus}]"
            :reload-fn="loadData"
          />
          <ActionMenu
            v-if="registry"
            button-role="multiAction"
            :resource="registry"
            data-testid="masthead-action-menu"
            :button-aria-label="t('component.resource.detail.titleBar.ariaLabel.actionMenu', { resource: RESOURCE.REGISTRY })"
          />
        </div>
      </div>
      <RancherMeta :properties="registryMetadata" />
    </div>
    <RegistryDetailScanTable :scan-history="scanHistory" />
  </div>
</template>

<script>
import { PRODUCT_NAME, RESOURCE, PAGE } from '@pkg/types';
import ActionMenu from '@shell/components/ActionMenuShell.vue';
import RancherMeta from './common/RancherMeta.vue';
import RegisterStatusBadge from './common/RegisterStatusBadge.vue';
import RegistryDetailScanTable from './RegistryDetailScanTable.vue';
import ScanButton from './common/ScanButton.vue';

export default {
  name:       'RegistryDetails',
  components: {
    RancherMeta,
    RegisterStatusBadge,
    RegistryDetailScanTable,
    ScanButton,
    ActionMenu
  },
  data() {
    return {
      PRODUCT_NAME,
      RESOURCE,
      PAGE,
      registry:         null,
      registryStatus:   null,
      registryMetadata: [],
      scanHistory:      [],
    };
  },
  async fetch() {
    await this.loadData();
  },
  methods: {
    async loadData(isForceLoading = false) {
      this.registry = await this.$store.dispatch('cluster/find', { type: RESOURCE.REGISTRY, id: `${ this.$route.params.ns }/${ this.$route.params.id }` });
      this.scanHistory = (await this.$store.dispatch('cluster/findAll', { type: RESOURCE.SCAN_JOB })).filter((rec) => {
        return rec.spec.registry === this.registry.metadata.name;
      });

      this.registryStatus = this.registry.scanRec.currStatus;
      this.registryMetadata = [
        {
          type:  'text',
          label: this.t('imageScanner.registries.configuration.meta.namespace'),
          value: this.registry.metadata.namespace
        },
        {
          type:  'text',
          label: this.t('imageScanner.registries.configuration.meta.repositories'),
          value: this.registry.spec.repositories?.length || 0
        },
        {
          type:  'text',
          label: this.t('imageScanner.registries.configuration.meta.schedule')
        },
        {
          type:  'text',
          label: this.t('imageScanner.registries.configuration.meta.uri'),
          value: this.registry.spec.uri
        },
        {
          type: 'tags',
          tags: this.registry.spec.repositories || []
        },
        {
          type:  'text',
          value: this.registry.spec.scanInterval ? this.t('imageScanner.general.schedule', { i: this.registry.spec.scanInterval }) : '',
        }
      ];
    },
  },
};
</script>

<style lang="scss" scoped>
  .btn {
    padding: 0 16px;
    gap: 12px;
  }

  .registry-details {
    display: flex;
    padding: 24px;
    flex-direction: column;
    align-items: flex-start;
    gap: 24px;
    flex: 1 0 0;
    align-self: stretch;
  }

  .about {
    /* layout */
    display: flex;
    padding-bottom: 24px;
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
    align-self: stretch;
    /* style */
    border-bottom: 1px dashed #DCDEE7;

    .header {
      /* layout */
      display: flex;
      align-items: flex-start;
      gap: 24px;
      align-self: stretch;
      /* style */
      border-radius: 6px;

      .resource-header {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        gap: 4px;
        flex: 1 0 0;

        .resource-header-name-state {
          display: flex;
          align-items: center;
          gap: 12px;
          align-self: stretch;

          .resource-header-name {
            font-family: Lato;
            font-size: 24px;
            font-style: normal;
            font-weight: 400;
            line-height: 32px; /* 133.333% */
          }
        }

        .resource-header-description {
          /* layout */
          display: flex;
          max-width: 900px;
          height: 21px;
          flex-direction: column;
          justify-content: center;
          /* typography */
          overflow: hidden;
          color: #717179;
          text-overflow: ellipsis;
          white-space: nowrap;
          font-family: Lato;
          font-size: 14px;
          font-style: normal;
          font-weight: 400;
          line-height: 21px; /* 150% */
        }
      }

      .resource-header-actions {
        display: flex;
        align-items: center;
        gap: 16px;

        &:deep() button[data-testid="masthead-action-menu"] {
          border-radius: 4px;
          width: 35px;
          height: 40px;

          display: inline-flex;
          flex-direction: row;
          justify-content: center;
          align-items: center;
        }
      }
    }
  }
</style>
