<template>
  
    <PaginatedResourceTable
      ref="registryTable"
      :headers="headers"
      :schema="schema"
      :namespaced="false"
      :table-actions="true"
      :row-actions="true"
      :fetchSecondaryResources="fetchSecondaryResources"
      :fetchPageSecondaryResources="fetchPageSecondaryResources"
      
      :use-query-params-for-simple-filtering="useQueryParamsForSimpleFiltering"
      :overflow-x="overflowX"
      :overflow-y="overflowY"
      @selection="onSelectionChange"
    >
    </PaginatedResourceTable>
</template>

<script>

  import { RESOURCE } from "@pkg/types";
  import PaginatedResourceTable from '@shell/components/PaginatedResourceTable';
  import SortableTable from '@shell/components/SortableTable';
  import { REGISTRY_SCAN_TABLE } from "@pkg/config/table-headers";
  import { FilterArgs, PaginationFilterField, PaginationParamFilter } from '@shell/types/store/pagination.types';
  
  export default {
    name: 'registries',
    components: {
      PaginatedResourceTable,
      SortableTable,
    },
    data() {
      return {
        headers: REGISTRY_SCAN_TABLE,
      }
    },
    beforeUnmount() {
      clearInterval(this.keepAliveTimer);
    },
    methods: {
      async fetchSecondaryResources({ canPaginate }) {
        if (canPaginate) {
          return;
        }
        console.log("fetchSecondaryResources");
        return await this.$store.dispatch(`cluster/findAll`, { type: RESOURCE.SCAN_JOB });
      },

      /**
       * PV columns need other resources in order to show data in some columns
       *
       * So when we have a page.... use those entries as filters when fetching the other resources
       */
      async fetchPageSecondaryResources({ canPaginate, force, page }) {
          if (!page?.length) {
              return;
          }

          const opt = {
              force,
              pagination: new FilterArgs({
              filters: PaginationParamFilter.createMultipleFields(page.map((r) => new PaginationFilterField({
                  field: 'id',
                  value: `${r.metadata.namespace}/${r.metadata.name}`
              }))),
              })
          };
          const scanJobs = await this.$store.dispatch(`cluster/findAll`, { type: RESOURCE.SCAN_JOB, opt });
          console.log("fetchSecondaryResources", scanJobs);
          return scanJobs;
      },
    },
  }

</script>