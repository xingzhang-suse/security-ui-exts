<template>
  <div class="page">
    <div class="header-section">
      <div class="header-left">
        <div class="title-wrap">
          <div class="title">{{ t('imageScanner.registries.title') }}</div>
        </div>
        <div class="state">
          State as of
          <span class="state-date-time">
            {{ latestUpdateDateText }}&nbsp;&nbsp;&nbsp;&nbsp;{{ latestUpdateTimeText }}
          </span>
        </div>
      </div>
      <div class="header-right">
        <div class="header-btn">
          <button
            mat-button
            class="btn role-secondary"
            aria-label="Refresh data"
            type="button"
            @click="refresh()">
            <em class="icon-refresh-ss"></em>{{ t('imageScanner.registries.button.refresh') }}
          </button>
        </div>
        <div class="header-btn">
          <button
            mat-button
            class="btn role-primary"
            aria-label="Add new"
            type="button"
            @click="openAddEditRegistry()">
            {{ t('imageScanner.registries.button.addNew') }}
          </button>
        </div>
      </div>
    </div>
    <div class="summary-section">
      <RecentUpdatedRegistries :registryStatusList="registryStatusList"/>
      <StatusDistribution :filterFn="filterByStatus" :chartData="statusSummary"/>
    </div>
    <div class="search-filters">
      <div class="filter-row">
        <div class="filter-item">
          <label>{{ t('imageScanner.registries.registrytable.header.registry')}}</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.registrySearch" 
              type="text" 
              :placeholder="t('imageScanner.registries.registrytable.filters.placeholder.name')"
              class="filter-input"
            />
            <i class="icon icon-search" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.registries.registrytable.header.namespace') }}</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.namespaceSearch" 
              type="text" 
              :placeholder="t('imageScanner.registries.registrytable.filters.placeholder.name')"
              class="filter-input"
            />
            <i class="icon icon-search" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.registries.registrytable.header.uri') }}</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.uriSearch" 
              type="text" 
              :placeholder="t('imageScanner.registries.registrytable.filters.placeholder.address')"
              class="filter-input"
            />
            <i class="icon icon-search" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.registries.registrytable.header.repos') }}</label>
          <div class="filter-input-wrapper">
            <input 
              v-model="filters.repositorySearch" 
              type="text" 
              :placeholder="t('imageScanner.registries.registrytable.filters.placeholder.name')"
              class="filter-input"
            />
            <i class="icon icon-search" style="color: #6C6C76; margin-left: 8px;"></i>
          </div>
        </div>
        <div class="filter-item">
          <label>{{ t('imageScanner.registries.registrytable.header.status') }}</label>
          <LabeledSelect
            v-model:value="filters.statusSearch"
            :options="filterStatusOptions"
            :close-on-select="true"
            :multiple="false"
          />
        </div>
      </div>
    </div>
    <SortableTable
      ref="registryTable"
      :headers="headers"
      :paginationHeaders="paginationHeaders"
      :schema="schema"
      :namespaced="false"
      :table-actions="true"
      :row-actions="true"
      :fetchSecondaryResources="fetchSecondaryResources"
      :fetchPageSecondaryResources="fetchPageSecondaryResources"
      :rows="filteredRows"
      
      :use-query-params-for-simple-filtering="useQueryParamsForSimpleFiltering"
      @selection="onSelectionChange"
    >
      <template #header-left>
          <div class="table-top-left">
            <ScanButton class="table-btn" :selectedRegistries="selectedRows?.map(row => {return {name: row.metadata.name, namespace: row.metadata.namespace, currStatus: row.currStatus}})" :reloadFn="loadData" />
            <button
              class="btn role-primary table-btn"
              :disabled="!(selectedRows && selectedRows.length)"
              @click="promptRemoveRegistry()"
            >
              <i class="icon icon-delete"></i>
              {{ t('imageScanner.registries.button.delete') || 'Delete' }}
            </button>
          </div>
      </template>
    </SortableTable>
  </div>
</template>

<script>

  import { RESOURCE } from "@pkg/types";
  import PaginatedResourceTable from '@shell/components/PaginatedResourceTable';
  import SortableTable from '@shell/components/SortableTable';
  import RecentUpdatedRegistries from "@pkg/components/RecentUpdatedRegistries";
  import StatusDistribution from "@pkg/components/StatusDistribution";
  import { REGISTRY_SCAN_TABLE } from "@pkg/config/table-headers";
  import {
    PRODUCT_NAME,
  } from "@pkg/types";
  import { escapeHtml } from '@shell/utils/string';
  import day from 'dayjs';
  import { DATE_FORMAT, TIME_FORMAT } from '@shell/store/prefs';
  import { findBy } from '@shell/utils/array';
  import ScanButton from "@pkg/components/common/ScanButton";
  import { FilterArgs, PaginationFilterField, PaginationParamFilter } from '@shell/types/store/pagination.types';
  import LabeledSelect from "@shell/components/form/LabeledSelect";
  
  export default {
    name: 'registries',
    components: {
      PaginatedResourceTable,
      RecentUpdatedRegistries,
      StatusDistribution,
      ScanButton,
      LabeledSelect,
      SortableTable,
    },
    data() {
      const STATUS_OPTIONS = [
        { value: 'any', label: this.t('imageScanner.general.any') },
        { value: 'scheduled', label: this.t('imageScanner.enum.status.scheduled') },
        { value: 'pending', label: this.t('imageScanner.enum.status.pending') },
        { value: 'inprogress', label: this.t('imageScanner.enum.status.inprogress') },
        { value: 'complete', label: this.t('imageScanner.enum.status.complete') },
        { value: 'failed', label: this.t('imageScanner.enum.status.failed') },
      ];
      return {
        registriesCRD: [],
        PRODUCT_NAME: PRODUCT_NAME,
        rows: [],
        registryStatusList: [],
        latestUpdateTime: null,
        statusSummary: {},
        headers: REGISTRY_SCAN_TABLE,
        paginationHeaders: [],
        selectedRows: [],
        filters: {
          registrySearch: '',
          namespaceSearch: '',
          uriSearch: '',
          repositorySearch: '',
          statusSearch: STATUS_OPTIONS[0],
        },
        filterStatusOptions: STATUS_OPTIONS,
        keepAliveTimer: null,
        useQueryParamsForSimpleFiltering: false,
      }
    },

    async fetch() {
      this.registriesCRD = await this.$store.dispatch('cluster/findAll', { type: RESOURCE.REGISTRY });
      if (this.$store.getters['cluster/canList'](RESOURCE.SCAN_JOB)) {
        await this.$store.dispatch('cluster/findAll', { type: RESOURCE.SCAN_JOB });
      }
      await this.loadData(false);
      clearInterval(this.keepAliveTimer);
      this.keepAliveTimer = setInterval(async () => {
        await this.loadData(true);
      }, 20 * 1000);
    },
    beforeUnmount() {
      clearInterval(this.keepAliveTimer);
    },
    methods: {
      async loadData(isReloading) {
        this.registryStatusList = [];
        this.statusSummary = {};
        if (isReloading) {
          this.registriesCRD = this.$store.getters['cluster/all'](RESOURCE.REGISTRY);
        }
        this.rows = this.registriesCRD;
        const summaryData = this.getSummaryData(this.registriesCRD);
        this.registryStatusList = summaryData.registryStatusList;
        this.statusSummary = summaryData.statusSummary;
      },
      refresh() {
        this.loadData();
      },
      filterByStatus(status) {
        this.filters.statusSearch = status;
      },
      openAddEditRegistry() {
        this.$router.push({
          name: `${ PRODUCT_NAME }-c-cluster-resource-create`,
          params: {
            resource: RESOURCE.REGISTRY,
            cluster: this.$route.params.cluster,
            product: PRODUCT_NAME
          }
        });
      },
      onSelectionChange(selected) {
        this.selectedRows = selected || [];
      },
      async promptRemoveRegistry() {
        const table = this.$refs.registryTable.$refs.table.$refs.table;
        const act = findBy(table.availableActions, 'action', 'promptRemove');
        if ( act ) {
          table.setBulkActionOfInterest(act);
          table.applyTableAction(act);
        }
        return;
      },
      getSummaryData(registriesCRD) {
        this.latestUpdateTime = new Date();
        let registryStatusList = [];
        const statusSummary = {
          pending: 0,
          scheduled: 0,
          inprogress: 0,
          complete: 0,
          failed: 0
        };

        registriesCRD.forEach((rec, index) => {
          // Summarize the data for Latest status updates panel
          const scanRec = _.cloneDeep(rec.scanRec || {});
          registryStatusList.push({
            registryName: rec.metadata.name,
            uri: rec.spec.uri,
            namespace: rec.metadata.namespace,
            prevScanStatus: scanRec?.previousStatus,
            currStatus: scanRec?.currStatus,
            lastTransitionTime: scanRec?.lastTransitionTime || rec.metadata.creationTimestamp,
          });

           //Summarize the data for Status distribution panel
          if (scanRec?.currStatus && statusSummary.hasOwnProperty(scanRec?.currStatus)) {
            statusSummary[scanRec?.currStatus]++;
          }
        });
        // Sort and limit the registryStatusList to 5 most recent updates
        registryStatusList = registryStatusList.sort((a, b) => new Date(b.lastTransitionTime) - new Date(a.lastTransitionTime)).slice(0, 5);
        while (registryStatusList.length < 5) {
          registryStatusList.push({
            registryName: "",
            uri: "",
            prevScanStatus: "",
            currStatus: "",
            lastTransitionTime: new Date().toISOString()
          });
        }

        return {
          registryStatusList,
          statusSummary
        }
      },
      async fetchSecondaryResources({ canPaginate }) {
        if (canPaginate) {
          return;
        }
        return await this.$store.dispatch(`cluster/findAll`, { type: RESOURCE.SCAN_JOB });
      },
      async fetchPageSecondaryResources({ canPaginate, force, page }) {
          if (!page?.length) {
              return;
          }

          const opt = {
              force,
              pagination: new FilterArgs({
              filters: PaginationParamFilter.createMultipleFields(page.map((r) => new PaginationFilterField({
                  field: 'id',
                  value: `${r.metadata.namespace}/${r.metadata.name}`
              }))),
              })
          };
          const scanJobs = await this.$store.dispatch(`cluster/findPage`, { type: RESOURCE.SCAN_JOB, opt });
          return scanJobs;
      },
    },
    computed: {
      schema() {
        return this.$store.getters['cluster/schemaFor'](RESOURCE.REGISTRY);
      },
      canPaginate() {
        const args = { id: RESOURCE.REGISTRY };
        return this.$store.getters[`cluster/paginationEnabled`]?.(args);
      },
      paginationHeaders() {
        const headers = REGISTRY_SCAN_TABLE.map(header => {
          // if (this.canPaginate) {
          //   console.log("canPaginate", this.canPaginate);
          //   header.sort = false;
          //   header.search = false;
          // }
          return header;
        });
        return headers;
      },
      latestUpdateDateText() {
        return day(new Date(this.latestUpdateTime).getTime()).format('MMM D, YYYY');
      },
      latestUpdateTimeText() {
        return day(new Date(this.latestUpdateTime).getTime()).format('h:mm A');
      },
      filteredRows() {
        const filtered = this.rows.filter(row => {
          const registryMatch = !this.filters.registrySearch ||
            row.metadata?.name?.toLowerCase().includes(this.filters.registrySearch.toLowerCase());

          const namespaceMatch = !this.filters.namespaceSearch ||
            row.metadata?.namespace?.toLowerCase().includes(this.filters.namespaceSearch.toLowerCase());

          const uriMatch = !this.filters.uriSearch ||
            row.spec?.uri?.toLowerCase().includes(this.filters.uriSearch.toLowerCase());

          const repoMatch = !this.filters.repositorySearch ||
            (row.spec?.repositories || [])
              .some(repo => repo.toLowerCase().includes(this.filters.repositorySearch.toLowerCase()));

          const statusMatch = !this.filters.statusSearch ||
            (typeof this.filters.statusSearch === 'object' && this.filters.statusSearch.value.toLowerCase() === 'any') ||
            (typeof this.filters.statusSearch === 'string' && this.filters.statusSearch.toLowerCase() === 'any') ||
            (typeof row.scanRec?.currStatus === 'object' && row.scanRec?.currStatus.value.toLowerCase() === this.filters.statusSearch.value.toLowerCase()) ||
            (typeof row.scanRec?.currStatus === 'string' && row.scanRec?.currStatus.toLowerCase() === this.filters.statusSearch.toLowerCase());

          return registryMatch && namespaceMatch && uriMatch && repoMatch && statusMatch;
        });
        return filtered;
      }
    },
  }
</script>

<style lang="scss" scoped>
  .page {
    display: flex;
    flex-direction: column;
    padding: 24px;
    min-height: 100%;
  }
  .header-section {
    display: flex;
    align-items: flex-start;
    gap: 24px;
    align-self: stretch;
  }
  .table-top-left {
      display: flex;
      align-items: start-end;
      justify-content: start;
      flex: 1 0 0;
      gap: 16px;
    .table-btn {
      height: 40px;
    }
  }
  .header-left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 4px;
      flex: 1 0 0;
    }
    .title-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      align-self: stretch;
      .title {
        color: #141419;
        font-family: Lato;
        font-size: 24px;
        font-style: normal;
        font-weight: 400;
        line-height: 32px; /* 133.333% */
      }
    }
    .state {
      display: -webkit-box;
      max-width: 900px;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 1;
      line-clamp: 1;
      align-self: stretch;
      overflow: hidden;
      color: #717179;

      text-overflow: ellipsis;
      font-family: Lato;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: 21px; /* 150% */

      .state-date-time {
        overflow: hidden;
        -webkit-box-orient: vertical;
        line-clamp: 1;
        color: #717179;
        text-overflow: ellipsis;
        font-family: Lato;
        font-size: 14px;
        font-style: normal;
        font-weight: 400;
        line-height: 21px;
      }
    }
    .header-right {
      display: flex;
      align-items: flex-end;
      justify-content: end;
      flex: 1 0 0;
      gap: 16px;
    }
    .header-btn {
      height: 40px;
    }
    .icon-add {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      background: url('../../../../assets/img/add.svg') no-repeat center center;
      background-size: contain;
    }
    .icon-refresh-ss {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      background: url('../../../../assets/img/refresh.svg') no-repeat center center;
      background-size: contain;
    }
  .summary-section {
    display: flex;
    min-width: 912px;
    align-items: flex-start;
    align-self: stretch;
    border-radius: 6px;
    border: 1px solid #DCDEE7;
    background: #FFF;
    margin: 24px 0;
  }

  .filter-row {
    display: flex;
    gap: 24px;
    margin-bottom: 20px;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
  }

  .filter-item label {
    font-weight: 400;
    color: #6C6C76;
    font-size: 14px;
  }

  .filter-input-wrapper {
    display: flex;
    align-items: center;
    border: 1px solid #DCDEE7;
    border-radius: 6px;
    padding: 0 12px;
    background: #FFF;
  }

  .filter-input {
    flex: 1;
    padding: 10px 0;
    border: none;
    outline: none;
    font-size: 14px;
    line-height: 19px;
    background: transparent;
  }

  .score-input {
    color: #BEC1D2;
  }

  .score-input::placeholder {
    color: #BEC1D2;
  }

  .filter-input:focus {
    outline: none;
  }

  .filter-input-wrapper:focus-within {
    border-color: #007cba;
    box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.1);
  }

  .filter-select {
    padding: 10px 14px;
    border: 1px solid #DCDEE7;
    border-radius: 6px;
    font-size: 14px;
    background: #FFF;
    outline: none;
  }

  .filter-select:focus {
    border-color: #007cba;
    box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.1);
  }

  .filter-actions {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 8px;
    padding-top: 16px;
    border-top: 1px solid #DCDEE7;
  }
   
</style>