<template>
  <div class="registry-details">
    <div class="about">
      <div class="header">
        <div class="resource-header">
          <div class="resource-header-name-state">
            <span class="resource-header-name">
              <RouterLink :to="`/c/${this.$route.params.cluster}/${ this.PRODUCT_NAME }/${ this.RESOURCE.REGISTRY }/`">{{ t('imageScanner.registries.title') }}:</RouterLink> 
              {{ $route.params.id }}
            </span>
            <RegisterStatusBadge :status="registryStatus" />
          </div>
          <span class="resource-header-description">
            Registry configuration description
          </span>
        </div>
        <div class="resource-header-actions">
          <button class="btn role-secondary">
            <i class="icon icon-refresh"></i>
            {{ t('imageScanner.general.refresh') }}
          </button>
          <button class="btn role-primary">
            <i class="icon icon-play"></i>
            {{ t('imageScanner.registries.configuration.scan') }}
          </button>
        </div>
      </div>
      <RancherMeta :properties="registryMetadata" />
    </div>
    Recent scans
    <ResourceTable
      :headers="headers"
      :rows="scanHistory"
      :namespaced="false"
      :rowActions="false"
      :search="false"
      class="table"
    />
  </div>
</template>

<script>
  import { BadgeState } from '@rancher/components';
  import { PRODUCT_NAME, RESOURCE } from '@sbombastic-image-vulnerability-scanner/types';
  import ResourceTable from "@shell/components/ResourceTable";
  import RancherMeta from './common/RancherMeta.vue';
  import RegisterStatusBadge from './common/RegisterStatusBadge.vue';
  import { REGISTRY_SCAN_HISTORY_TABLE } from '@sbombastic-image-vulnerability-scanner/config/table-headers';

  export default {
    name: 'registryDetails',
    components: {
      BadgeState,
      ResourceTable,
      RancherMeta,
      RegisterStatusBadge,
    },
    data() {
      return {
        PRODUCT_NAME,
        RESOURCE,
        registryStatus: null,
        registryMetadata: [],
        scanHistory: [],
        headers: REGISTRY_SCAN_HISTORY_TABLE
      }
    },
    async fetch() {

      await this.$store.dispatch('cluster/find', { type: RESOURCE.REGISTRY, id: `${this.$route.params.ns}/${this.$route.params.id}` });
      let registry = this.$store.getters['cluster/byId'](RESOURCE.REGISTRY, `${this.$route.params.ns}/${this.$route.params.id}`);

      await this.$store.dispatch('cluster/findAll', { type: RESOURCE.SCAN_JOB, opt: { namespaced: this.$route.params.ns } });
      let scanJobs = this.$store.getters['cluster/all'](RESOURCE.SCAN_JOB, { namespaced: this.$route.params.ns });

      // filter scan jobs for the current registry
      scanJobs = scanJobs.filter((job) => {
        return job.spec.registry === registry.metadata.name;
      });

      this.registryStatus = this.getRegistryStatus(registry);
      this.registryMetadata = [
        {
          type: 'text',
          label: this.t('imageScanner.registries.configuration.meta.registry'),
          value: registry.spec.uri
        },
        {
          type: 'text',
          label: this.t('imageScanner.registries.configuration.meta.repositories'),
          value: registry.spec.repositories.length
        },
        {
          type: 'text',
          label: this.t('imageScanner.registries.configuration.meta.schedule')
        },
        {
          type: 'text',
          label: this.t('imageScanner.registries.configuration.meta.namespace'),
          value: registry.metadata.namespace
        },
        {
          type: 'tags',
          tags: registry.spec.repositories || []
        },
        {
          type: 'text',
          value: registry.metadata.schedule || '',
        }
      ];

      this.scanHistory = scanJobs.map((rec) => {
        rec.status.statusResult = rec.status.conditions.filter(condition => {
          return condition.status === "True";
        })[0] || {
          type: "Pending",
          lastTransitionTime: null,
        };
        rec.status['scannedImagesCount'] = this.$route.params.id === 'kw-controller' ? 1000 : 500;
        rec.status['imagesCount'] = 2000;
        return rec;
      });

      console.log("Scan history:", this.scanHistory);
    },
    methods: {
      getRegistryStatus(registry) {
        if (!registry || !registry.status || !registry.status.conditions || !registry.status.conditions.length) {
          return null;
        }
        let status = registry.status.conditions[0].type.toLowerCase()  === "discovering" ? "InProgress" : registry.status.conditions[0].type;
        return status.toLowerCase();
      },
    },
  }
</script>

<style lang="scss" scoped>
  .btn {
    padding: 0 16px;
    gap: 12px;
  }

  .registry-details {
    display: flex;
    padding: 24px;
    flex-direction: column;
    align-items: flex-start;
    gap: 24px;
    flex: 1 0 0;
    align-self: stretch;

    .table {
      width: 100%;
    }
  }

  .about {
    /* layout */
    display: flex;
    padding-bottom: 24px;
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
    align-self: stretch;
    /* style */
    border-bottom: 1px dashed #DCDEE7;

    .header {
      /* layout */
      display: flex;
      align-items: flex-start;
      gap: 24px;
      align-self: stretch;
      /* style */
      border-radius: 6px;

      .resource-header {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        gap: 4px;
        flex: 1 0 0;

        .resource-header-name-state {
          display: flex;
          align-items: center;
          gap: 12px;
          align-self: stretch;

          .resource-header-name {
            font-family: Lato;
            font-size: 24px;
            font-style: normal;
            font-weight: 600;
            line-height: 32px; /* 133.333% */
          }
        }

        .resource-header-description {
          /* layout */
          display: flex;
          width: 900px;
          height: 21px;
          flex-direction: column;
          justify-content: center;
          /* typography */
          overflow: hidden;
          color: #717179;
          text-overflow: ellipsis;
          white-space: nowrap;
          font-family: Lato;
          font-size: 14px;
          font-style: normal;
          font-weight: 400;
          line-height: 21px; /* 150% */
        }
      }

      .resource-header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }
    }
  }
</style>