<template>
  <button
    class="btn role-primary scan-btn"
    :disabled="disableBtn"
    @click="startScan()"
>
    <i class="icon icon-play"></i>
    {{ t('imageScanner.registries.button.startScan') || 'Enable' }}
  </button>
</template>

<script>
import { RESOURCE } from "@pkg/types";

export default {
  name: 'scanButton',
  props: {
    // Element object -> { name: string, namespace: string }
    selectedRegistries: {
      type: Array,
      default: () => []
    },
  },
  methods: {
    async startScan() {
        if (!this.selectedRegistries || !this.selectedRegistries.length) {
            return;
        }
        this.selectedRegistries.filter(registry => {
          return !registry.currStatus || ["none", "failed", "complete"].includes(registry.currStatus.toLowerCase());
        }).forEach(async (registry) => {
            const scanjobObj = await this.$store.dispatch('cluster/create', {
                type: RESOURCE.SCAN_JOB,
                metadata: {
                    generateName: registry.name,
                    namespace: registry.namespace,
                },
                spec: {
                    registry: registry.name,
                }
            });
            try {
                await scanjobObj.save();
                this.$store.dispatch('growl/success', {
                    title: this.t('imageScanner.registries.messages.registryScanComplete'),
                    message: this.t('imageScanner.registries.messages.registryScanComplete', { name: registry.name }),
                });
            } catch (e) {
                this.$store.dispatch('growl/error', {
                    title: this.t('imageScanner.registries.messages.registryScanFailed'),
                    message: e.message,
                });
            }
        });
    },
  },
  computed: {
    disableBtn() {
      return !(this.selectedRegistries && this.selectedRegistries.length) ||
        !this.selectedRegistries.some(registry => {
          return !registry.currStatus || ["none", "failed", "complete"].includes(registry.currStatus.toLowerCase());
        });
    },
  },
}
</script>

<style scoped>
.scan-btn {
  display: flex;
  align-items: center;
  gap: 12px;
}
</style>
